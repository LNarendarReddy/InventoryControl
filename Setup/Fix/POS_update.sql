USE [C:\Windows\NSRetailPOS\NSRETAILPOS.MDF]
GO
:ON ERROR EXIT
GO

/****** Object:  StoredProcedure [dbo].[POS_USP_R_USERCREDENTIALS]    Script Date: 01-05-2024 15:44:03 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER   PROCEDURE [dbo].[POS_USP_R_USERCREDENTIALS]          
@BRANCHID INT,          
@BRANCHCOUNTERID INT,          
@USERNAME NVARCHAR(100),          
@PASSWORDSTRING NVARCHAR(200),      
@HDDSNO NVARCHAR(50)      
AS          
BEGIN          
      
	IF NOT EXISTS (SELECT 1 FROM POS_BRANCHCOUNTER BC WHERE BC.COUNTERID = @BRANCHCOUNTERID AND BC.HDDSNO = @HDDSNO)      
	BEGIN      
		SELECT 'Machine identifier mismatch, application will exit'      
		RETURN      
	END      
          
	DECLARE @USERID INT          
	SELECT @USERID = USERID     
	FROM   
		POS_TBLUSER USR    
		INNER JOIN POS_TBLROLE R ON R.ROLEID = USR.ROLEID    
	WHERE (BRANCHID = @BRANCHID OR R.ROLENAME = 'Store Admin')    
		AND USERNAME = @USERNAME           
		AND PASSWORDSTRING = @PASSWORDSTRING    
		AND USR.DELETEDDATE IS NULL
  
	DECLARE @DBVersion NVARCHAR(50)  
	SELECT @DBVersion = CONFIGVALUE FROM TBLCONFIG WHERE CONFIGNAME = 'DBVersion'  
          
	IF(@USERID  > 0)          
	BEGIN          
          
		SELECT           
		USERID, USERNAME, PASSWORDSTRING, FULLNAME, CNUMBER, EMAIL, ISOTP, GENDER,          
		B.BRANCHID, BRANCHNAME, BRANCHCODE, ADDRESS, PHONENO, LANDLINE,    
		R.ROLENAME, B.MULTIEDITTHRESHOLD, @DBVersion AS DBVersion, B.FILTERMRPBYSTOCK , U.CATEGORYID 
		FROM   
		POS_TBLUSER U     
		INNER JOIN POS_BRANCH B ON @BRANCHID = B.BRANCHID          
		INNER JOIN POS_TBLROLE R ON U.ROLEID = R.ROLEID    
		WHERE USERID = @USERID          
        
		SELECT COUNTERID,      
		COUNTERNAME FROM POS_BRANCHCOUNTER        
		WHERE COUNTERID = @BRANCHCOUNTERID        
          
	END          
	ELSE          
	BEGIN          
          
		SELECT 'Invalid Username or Password!'          
          
	END          
          
END 
GO


CREATE OR ALTER PROCEDURE [dbo].[USP_R_ITEMDATAFORITEMDETAILS] 
@ITEMCODEID INT
AS
BEGIN
	
	SELECT MRP, SALEPRICE
	FROM POS_ITEMPRICE 
	WHERE ITEMCODEID = @ITEMCODEID
		AND DELETEDDATE IS NULL
		AND QTYORWEIGHTINKGS > 0

	SELECT OT.OFFERTYPENAME, OFR.OFFERCODE, OFR.OFFERVALUE
	FROM POS_OFFERITEMMAP OIM 
		INNER JOIN POS_OFFER OFR ON OIM.OFFERID = OFR.OFFERID
		INNER JOIN POS_OFFERTYPE OT ON OFR.OFFERTYPEID = OT.OFFERTYPEID
		INNER JOIN POS_OFFERBRANCH OB ON OB.OFFERID = OFR.OFFERID
	WHERE OIM.ITEMCODEID = @ITEMCODEID
		AND OFR.DELETEDDATE IS NULL
		AND OIM.DELETEDDATE IS NULL
		AND OB.DELETEDDATE IS NULL
	ORDER BY OFR.OFFERID DESC

END
GO

UPDATE TBLCONFIG SET CONFIGVALUE = '1.5.9' WHERE CONFIGID = 1
GO