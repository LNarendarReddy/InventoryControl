USE [C:\Windows\NSRetailPOS\NSRETAILPOS.MDF]
GO
:ON ERROR EXIT
GO

/****** Object:  StoredProcedure [dbo].[POS_USP_R_GETBILLOFFERS]    Script Date: 20-12-2025 13:29:42 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER   PROC [dbo].[POS_USP_R_GETBILLOFFERS]
(
	@BillID INT
)
AS
BEGIN

	DECLARE @MaxDate DATE, @OfferID INT, @TotalBill DECIMAL(14, 2)
	SELECT @MaxDate = '2100-01-01'
	
	
	SELECT OFR.OFFERID, 0 AS SUBITEMSTOTAL, OFRTYP.OFFERTYPEID
	INTO #AvailableOffers
	FROM
		POS_OFFER OFR
		INNER JOIN POS_OFFERBRANCH OFRB ON OFRB.OFFERID = OFR.OFFERID	
		INNER JOIN POS_OFFERTYPE OFRTYP ON OFRTYP.OFFERTYPEID = OFR.OFFERTYPEID
	WHERE 
		GETDATE() BETWEEN OFR.STARTDATE AND ISNULL(OFR.ENDDATE, @MaxDate)
		AND OFR.ISACTIVE = 1
		AND OFR.DELETEDDATE IS NULL
		AND OFRB.DELETEDDATE IS NULL
		AND OFRTYP.OFFERTYPEID = 1004

		
	UPDATE AO
	SET SUBITEMSTOTAL = SUBTOTALS.SUBITEMSTOTAL
	FROM
		#AvailableOffers AO
		INNER JOIN 
			(
				SELECT AOINNER.OFFERID, SUM(PBD.BILLEDAMOUNT) SUBITEMSTOTAL
				FROM 
					POS_BILLDETAIL PBD						
					CROSS APPLY #AvailableOffers AOINNER
					INNER JOIN POS_ITEMPRICE IP ON IP.ITEMPRICEID = PBD.ITEMPRICEID
					INNER JOIN POS_ITEMCODE IC ON IC.ITEMCODEID = IP.ITEMCODEID
					INNER JOIN POS_ITEM I ON I.ITEMID = IC.ITEMID
				WHERE
					PBD.BILLID = @BillID
					AND PBD.DELETEDDATE IS NULL
					AND NOT EXISTS
						(
							SELECT 1 
							FROM OFFEREXCLUSION OE 
							WHERE 
								OE.ISCATEGORY = 0
								AND OE.EXCLUSIONID = IC.ITEMCODEID
								AND OE.OFFERID = AOINNER.OFFERID
								AND OE.DELETEDDATE IS NULL
						)
					AND NOT EXISTS
						(
							SELECT 1 
							FROM OFFEREXCLUSION OE 
							WHERE 
								OE.ISCATEGORY = 1
								AND OE.EXCLUSIONID = I.CATEGORYID
								AND OE.OFFERID = AOINNER.OFFERID
								AND OE.DELETEDDATE IS NULL
						)
				GROUP BY AOINNER.OFFERID						
			) SUBTOTALS ON SUBTOTALS.OFFERID = AO.OFFERID
	WHERE AO.OFFERTYPEID = 1004


	INSERT INTO #AvailableOffers
	SELECT OFR.OFFERID, 0, OFRTYP.OFFERTYPEID 
	FROM
		POS_OFFER OFR
		INNER JOIN POS_OFFERBRANCH OFRB ON OFRB.OFFERID = OFR.OFFERID	
		INNER JOIN POS_OFFERTYPE OFRTYP ON OFRTYP.OFFERTYPEID = OFR.OFFERTYPEID
	WHERE 
		GETDATE() BETWEEN OFR.STARTDATE AND ISNULL(OFR.ENDDATE, @MaxDate)
		AND OFR.ISACTIVE = 1
		AND OFR.DELETEDDATE IS NULL
		AND OFRB.DELETEDDATE IS NULL
		AND OFRTYP.OFFERTYPEID = 1005


	UPDATE AO
	SET AO.SUBITEMSTOTAL = BA.BILLEDAMOUNT
	FROM
		#AvailableOffers AO			
		INNER JOIN 
			(
				SELECT OFRIM.OFFERID, SUM(PBD.BILLEDAMOUNT) AS BILLEDAMOUNT
				FROM
					POS_ITEMPRICE IP
					INNER JOIN POS_BILLDETAIL PBD ON PBD.ITEMPRICEID = IP.ITEMPRICEID
					INNER JOIN POS_OFFERITEMMAP OFRIM ON OFRIM.ITEMCODEID = IP.ITEMCODEID
				WHERE 
					PBD.DELETEDDATE IS NULL
					AND PBD.BILLID = @BillID
					AND OFRIM.DELETEDDATE IS NULL
				GROUP BY OFRIM.OFFERID
			) BA ON BA.OFFERID = AO.OFFERID
	WHERE AO.OFFERTYPEID = 1005
		
		
	SELECT IP.ITEMPRICEID, I.SKUCODE, I.ITEMNAME, IC.ITEMCODE
		, IP.MRP, IP.SALEPRICE, ISNULL(OFR.OFFERTHRESHOLDPRICE, 0) ACTUALSALEPRICE
	FROM 
		#AvailableOffers AO		
		INNER JOIN POS_OFFER OFR ON OFR.OFFERID = AO.OFFERID
		INNER JOIN POS_ITEMPRICE IP ON IP.ITEMPRICEID = OFR.FREEITEMPRICEID
		INNER JOIN POS_ITEMCODE IC ON IC.ITEMCODEID = IP.ITEMCODEID
		INNER JOIN POS_ITEM I ON I.ITEMID = IC.ITEMID
	WHERE OFR.OFFERVALUE <= AO.SUBITEMSTOTAL
	ORDER BY AO.SUBITEMSTOTAL DESC
		
	/*
	SELECT OFR.OFFERID, 0 AS SUBITEMSTOTAL
	INTO #AvailableOffers
	FROM
		POS_OFFER OFR
		INNER JOIN POS_OFFERBRANCH OFRB ON OFRB.OFFERID = OFR.OFFERID	
		INNER JOIN POS_OFFERTYPE OFRTYP ON OFRTYP.OFFERTYPEID = OFR.OFFERTYPEID
	WHERE 
		GETDATE() BETWEEN OFR.STARTDATE AND ISNULL(OFR.ENDDATE, @MaxDate)
		AND OFR.ISACTIVE = 1
		AND OFR.DELETEDDATE IS NULL
		AND OFRB.DELETEDDATE IS NULL
		AND OFRTYP.OFFERTYPEID = 1004

	IF EXISTS ( SELECT 1 FROM #AvailableOffers )
	BEGIN
		
		UPDATE AO
		SET SUBITEMSTOTAL = SUBTOTALS.SUBITEMSTOTAL
		FROM
			#AvailableOffers AO
			INNER JOIN 
				(
					SELECT AOINNER.OFFERID, SUM(PBD.BILLEDAMOUNT) SUBITEMSTOTAL
					FROM 
						POS_BILLDETAIL PBD						
						CROSS APPLY #AvailableOffers AOINNER
						INNER JOIN POS_ITEMPRICE IP ON IP.ITEMPRICEID = PBD.ITEMPRICEID
						INNER JOIN POS_ITEMCODE IC ON IC.ITEMCODEID = IP.ITEMCODEID
						INNER JOIN POS_ITEM I ON I.ITEMID = IC.ITEMID
					WHERE
						PBD.BILLID = @BillID
						AND PBD.DELETEDDATE IS NULL
						AND NOT EXISTS
							(
								SELECT 1 
								FROM OFFEREXCLUSION OE 
								WHERE 
									OE.ISCATEGORY = 0
									AND OE.EXCLUSIONID = IC.ITEMCODEID
									AND OE.OFFERID = AOINNER.OFFERID
									AND OE.DELETEDDATE IS NULL
							)
						AND NOT EXISTS
							(
								SELECT 1 
								FROM OFFEREXCLUSION OE 
								WHERE 
									OE.ISCATEGORY = 1
									AND OE.EXCLUSIONID = I.CATEGORYID
									AND OE.OFFERID = AOINNER.OFFERID
									AND OE.DELETEDDATE IS NULL
							)
					GROUP BY AOINNER.OFFERID						
				) SUBTOTALS ON SUBTOTALS.OFFERID = AO.OFFERID

		SELECT IP.ITEMPRICEID, I.SKUCODE, I.ITEMNAME, IC.ITEMCODE
			, IP.MRP, IP.SALEPRICE, ISNULL(OFR.OFFERTHRESHOLDPRICE, 0) ACTUALSALEPRICE
		FROM 
			#AvailableOffers AO
			INNER JOIN POS_OFFER OFR ON OFR.OFFERID = AO.OFFERID
			INNER JOIN POS_ITEMPRICE IP ON IP.ITEMPRICEID = OFR.FREEITEMPRICEID
			INNER JOIN POS_ITEMCODE IC ON IC.ITEMCODEID = IP.ITEMCODEID
			INNER JOIN POS_ITEM I ON I.ITEMID = IC.ITEMID
		WHERE OFR.OFFERVALUE <= AO.SUBITEMSTOTAL
		ORDER BY OFR.OFFERVALUE DESC

		RETURN
	END

	INSERT INTO #AvailableOffers
	SELECT OFR.OFFERID, 0
	FROM
		POS_OFFER OFR
		INNER JOIN POS_OFFERBRANCH OFRB ON OFRB.OFFERID = OFR.OFFERID	
		INNER JOIN POS_OFFERTYPE OFRTYP ON OFRTYP.OFFERTYPEID = OFR.OFFERTYPEID
	WHERE 
		GETDATE() BETWEEN OFR.STARTDATE AND ISNULL(OFR.ENDDATE, @MaxDate)
		AND OFR.ISACTIVE = 1
		AND OFR.DELETEDDATE IS NULL
		AND OFRB.DELETEDDATE IS NULL
		AND OFRTYP.OFFERTYPEID = 1005

	IF EXISTS ( SELECT 1 FROM #AvailableOffers )
	BEGIN

		UPDATE AO
		SET AO.SUBITEMSTOTAL = BA.BILLEDAMOUNT
		FROM
			#AvailableOffers AO			
			INNER JOIN 
				(
					SELECT OFRIM.OFFERID, SUM(PBD.BILLEDAMOUNT) AS BILLEDAMOUNT
					FROM
						POS_ITEMPRICE IP
						INNER JOIN POS_BILLDETAIL PBD ON PBD.ITEMPRICEID = IP.ITEMPRICEID
						INNER JOIN POS_OFFERITEMMAP OFRIM ON OFRIM.ITEMCODEID = IP.ITEMCODEID
					WHERE 
						PBD.DELETEDDATE IS NULL
						AND PBD.BILLID = @BillID
						AND OFRIM.DELETEDDATE IS NULL
					GROUP BY OFRIM.OFFERID
				) BA ON BA.OFFERID = AO.OFFERID
		
		
		SELECT IP.ITEMPRICEID, I.SKUCODE, I.ITEMNAME, IC.ITEMCODE
			, IP.MRP, IP.SALEPRICE, ISNULL(OFR.OFFERTHRESHOLDPRICE, 0) ACTUALSALEPRICE
		FROM 
			#AvailableOffers AO		
			INNER JOIN POS_OFFER OFR ON OFR.OFFERID = AO.OFFERID
			INNER JOIN POS_ITEMPRICE IP ON IP.ITEMPRICEID = OFR.FREEITEMPRICEID
			INNER JOIN POS_ITEMCODE IC ON IC.ITEMCODEID = IP.ITEMCODEID
			INNER JOIN POS_ITEM I ON I.ITEMID = IC.ITEMID
		WHERE OFR.OFFERVALUE <= AO.SUBITEMSTOTAL
		ORDER BY AO.SUBITEMSTOTAL DESC
		
		RETURN
	END

	*/

END
GO

/****** Object:  StoredProcedure [dbo].[POS_USP_D_BILLDETAIL]    Script Date: 19-01-2026 14:55:20 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[POS_USP_D_BILLDETAIL]  
 @BillDetailID int  
 , @UserID int  
 , @SNos POS_BILLDETAILSNO READONLY  
AS  
BEGIN  
 UPDATE POS_BILLDETAIL  
 SET DELETEDDATE = GETDATE()  
 WHERE BILLDETAILID = @BillDetailID  
  
 UPDATE BD  
 SET SNO = SNOS.SNO  
 FROM  
  POS_BILLDETAIL BD   
  INNER JOIN @SNos SNOS ON SNOS.BILLDETAILID = BD.BILLDETAILID  
  
 DECLARE @OfferID INT, @DealID INT, @OfferAppliesToID INT, @DealAppliesToID INT, @ItemPriceID INT  
  , @BillID INT, @DealTypeID INT
  
 SELECT @ItemPriceID = ITEMPRICEID, @BillID = BILLID  
 FROM POS_BILLDETAIL WhERE BILLDETAILID = @BillDetailID  
  
 SELECT @OfferID = OFFERID, @OfferAppliesToID = OFFERAPPLIESTOID, @DealID = DEALID, @DealAppliesToID = DEALAPPLIESTOID  
 FROM UDF_GETOFFERS(@ItemPriceID,0)  
  
 CREATE TABLE #BilledGroupItems(BILLDETAILID INT, TOTALQUANTITY INT, MRPQUANTITY INT, SALEPRICEQUANTITY INT, FREEQUANTITY INT)  

 SELECT @DealTypeID = OFFERTYPEID FROM POS_OFFER WHERE OFFERID = @DealID AND ISNULL(@DealID,0) > 0

  
 IF (@DealTypeID = 4 OR @DealTypeID = 5) AND @DealAppliesToID >= 2
 BEGIN  
    
  DECLARE @MRPQuantity INT, @FreeQuantity INT, @SalePriceQuantity INT, @DealQuantity INT  
  
  SELECT @DealQuantity = OFRTYP.BUYQUANTITY + OFRTYP.FREEQUANTITY   
  FROM   
   POS_OFFER OFR  
   INNER JOIN POS_OFFERTYPE OFRTYP ON OFRTYP.OFFERTYPEID = OFR.OFFERTYPEID  
  WHERE  
   OFR.OFFERID = @DealID  
  
  
  INSERT INTO #BilledGroupItems  
  SELECT BD.BILLDETAILID, BD.QUANTITY AS TOTALQUANTITY, 0 AS MRPQUANTITY, 0 AS SALEPRICEQUANTITY, 0 AS FREEQUANTITY   
  FROM  
   POS_BILLDETAIL BD  
   INNER JOIN POS_ITEMPRICE IP ON IP.ITEMPRICEID = BD.ITEMPRICEID  
   INNER JOIN POS_OFFERITEMMAP OFRITM ON OFRITM.ITEMCODEID = IP.ITEMCODEID
  WHERE  
   BD.BILLID = @BillID  
   AND BD.DELETEDDATE IS NULL  
   AND OFRITM.OFFERID = @DealID  
  
  DEClARE @BuyQuantity INT  
  SELECT @BuyQuantity = SUM(TOTALQUANTITY) FROM #BilledGroupItems  
     
  SELECT @MRPQuantity = (@BuyQuantity / (OFRTYPE.BUYQUANTITY + OFRTYPE.FREEQUANTITY)) * OFRTYPE.BUYQUANTITY  
   , @FreeQuantity = (@BuyQuantity / (OFRTYPE.BUYQUANTITY + OFRTYPE.FREEQUANTITY)) * OFRTYPE.FREEQUANTITY  
   , @SalePriceQuantity = (@BuyQuantity % (OFRTYPE.BUYQUANTITY + OFRTYPE.FREEQUANTITY))  
  FROM   
   POS_OFFER OFR  
   INNER JOIN POS_OFFERTYPE OFRTYPE ON OFRTYPE.OFFERTYPEID = OFR.OFFERTYPEID  
  WHERE OFR.OFFERID = @DealID  
          
  -- Find lowest MRP items to give as free  
  WHILE @FreeQuantity > 0  
  BEGIN  
   DECLARE @CurBillDetailID INT, @CurQuantity INT  
  
   SELECT TOP 1 @CurBillDetailID = BGI.BILLDETAILID, @CurQuantity = BGI.TOTALQUANTITY  
   FROM   
    #BilledGroupItems BGI   
    INNER JOIN POS_BILLDETAIL BD ON BD.BILLDETAILID = BGI.BILLDETAILID  
    INNER JOIN POS_ITEMPRICE IP ON IP.ITEMPRICEID = BD.ITEMPRICEID  
   WHERE BGI.TOTALQUANTITY > 0  
   ORDER BY IP.MRP  
       
   DECLARE @FreeQuantityToupdate INT  
   IF @CurQuantity >= @FreeQuantity  
   BEGIN  
    SELECT @CurQuantity = @CurQuantity - @FreeQuantity, @FreeQuantityToupdate = @FreeQuantity, @FreeQuantity = 0  
   END  
   ELSE  
   BEGIN  
    SELECT @FreeQuantityToupdate = @FreeQuantity - @CurQuantity, @FreeQuantity = @FreeQuantity - @CurQuantity, @CurQuantity = 0  
   END  
  
   UPDATE #BilledGroupItems  
   SET TOTALQUANTITY = @CurQuantity, FREEQUANTITY = @FreeQuantityToupdate  
   WHERE BILLDETAILID = @CurBillDetailID  
  END  
  
  -- Find next lowest MRP items to give as sale price  
  WHILE @SalePriceQuantity > 0  
  BEGIN  
  
   SELECT TOP 1 @CurBillDetailID = BGI.BILLDETAILID, @CurQuantity = BGI.TOTALQUANTITY  
   FROM   
    #BilledGroupItems BGI   
    INNER JOIN POS_BILLDETAIL BD ON BD.BILLDETAILID = BGI.BILLDETAILID  
    INNER JOIN POS_ITEMPRICE IP ON IP.ITEMPRICEID = BD.ITEMPRICEID  
   WHERE BGI.TOTALQUANTITY > 0  
   ORDER BY IP.MRP  
  
   DECLARE @SalePriceToUpdate INT  
   IF @CurQuantity >= @SalePriceQuantity  
   BEGIN  
    SELECT @CurQuantity = @CurQuantity - @SalePriceQuantity, @SalePriceToUpdate = @SalePriceQuantity, @SalePriceQuantity = 0  
   END  
   ELSE  
   BEGIN  
    SELECT @SalePriceToUpdate = @SalePriceQuantity - @CurQuantity, @SalePriceQuantity = @SalePriceQuantity - @CurQuantity, @CurQuantity = 0  
   END  
  
   UPDATE #BilledGroupItems  
   SET TOTALQUANTITY = @CurQuantity, SALEPRICEQUANTITY = @SalePriceToUpdate  
   WHERE BILLDETAILID = @CurBillDetailID  
  END  
          
  UPDATE #BilledGroupItems  
  SET MRPQUANTITY = TOTALQUANTITY   
  
  -- update quantities and MRP based prices instead of sale prices  
  UPDATE BD  
  SET     
   BD.BILLEDAMOUNT = (BGI.MRPQUANTITY * IP.MRP) + (BGI.SALEPRICEQUANTITY * (IP.MRP - dbo.UDF_GET_DISCOUNTVALUE(dbo.UDF_GETOFFER(IP.ITEMPRICEID, BGI.SALEPRICEQUANTITY), IP.ITEMPRICEID)))  
   , BD.DISCOUNT = (BGI.FREEQUANTITY * IP.MRP) + (BGI.SALEPRICEQUANTITY * dbo.UDF_GET_DISCOUNTVALUE(dbo.UDF_GETOFFER(IP.ITEMPRICEID, BGI.SALEPRICEQUANTITY), IP.ITEMPRICEID))  
   , BD.OFFERID = CASE WHEN @BuyQuantity / @DealQuantity > 0 THEN @DealID ELSE @OfferID END  
  FROM  
   POS_BILLDETAIL BD  
   INNER JOIN #BilledGroupItems BGI ON BGI.BILLDETAILID = BD.BILLDETAILID  
   INNER JOIN POS_ITEMPRICE IP ON IP.ITEMPRICEID = BD.ITEMPRICEID  
  
 
 END  
 ELSE
 
 DECLARE @BuyDealID INT = 0
 SELECT @BuyDealID = OFFERID FROM POS_BILLDETAIL WHERE BILLDETAILID = @BillDetailID

 IF EXISTS (SELECT 1 FROM POS_OFFER WHERE OFFERID = @BuyDealID AND OFFERTYPEID = 1006)
 BEGIN
	
	INSERT INTO #BilledGroupItems(BILLDETAILID)
	SELECT BILLDETAILID FROM POS_BILLDETAIL PBD
	WHERE PBD.BILLID = @BillID AND PBD.OFFERID = @BuyDealID AND PBD.DELETEDDATE IS NULL

	UPDATE PBD
	SET 
		PBD.BILLEDAMOUNT = (PBD.QUANTITY * (IP.MRP - dbo.UDF_GET_DISCOUNTVALUE(dbo.UDF_GETOFFER(IP.ITEMPRICEID, PBD.QUANTITY), IP.ITEMPRICEID)))
		, PBD.DISCOUNT = (PBD.QUANTITY * dbo.UDF_GET_DISCOUNTVALUE(dbo.UDF_GETOFFER(IP.ITEMPRICEID, PBD.QUANTITY), IP.ITEMPRICEID))
		, PBD.OFFERID = dbo.UDF_GETOFFER(IP.ITEMPRICEID, PBD.QUANTITY)
	FROM POS_BILLDETAIL PBD
		INNER JOIN #BilledGroupItems BGI ON PBD.BILLDETAILID = BGI.BILLDETAILID
		INNER JOIN POS_ITEMPRICE IP ON IP.ITEMPRICEID = PBD.ITEMPRICEID

 END
  
	-- recalculate GST in case of offer or deals  
	  UPDATE BD  
	  SET   
	   BD.CGST = ROUND((BD.BILLEDAMOUNT * GST.CGST) / 100, 2)  
	   , BD.SGST = ROUND((BD.BILLEDAMOUNT * GST.SGST) / 100, 2)  
	   --, BD.IGST = ROUND((BD.BILLEDAMOUNT * GST.IGST) / 100, 2)  
	   , BD.CESS = ROUND((BD.BILLEDAMOUNT * GST.CESS) / 100, 2)  
	   , BD.GSTVALUE = ROUND((BD.BILLEDAMOUNT * (GST.CGST + GST.SGST + GST.IGST + GST.CESS)) / 100, 2)  
	  FROM  
	   POS_BILLDETAIL BD  
	   INNER JOIN #BilledGroupItems BGI ON BGI.BILLDETAILID = BD.BILLDETAILID  
	   INNER JOIN POS_GSTDETAIL GST ON GST.GSTID = BD.GSTID  

 SELECT                      
  BD.BILLDETAILID, B.BILLID, IP.ITEMPRICEID,              
  BD.SNO, I.ITEMNAME, IC.ITEMCODE, ISNULL(IC.HSNCODE,'') AS HSNCODE,IP.MRP                    
  , IP.SALEPRICE, GST.GSTCODE, BD.QUANTITY,              
  BD.WEIGHTINKGS, BD.BILLEDAMOUNT,              
  BD.CGST, BD.SGST, BD.IGST, BD.CESS,              
  BD.GSTVALUE, BD.GSTID,GST.CGST AS CGSTDESC,              
  GST.SGST AS SGSTDESC,GST.CESS AS CESSDESC,              
  ISNULL(I.ISOPENITEM,0) AS ISOPENITEM, DISCOUNT, BD.OFFERID, OFRTYP.OFFERTYPECODE  
 FROM                      
  POS_BILLDETAIL BD       
  INNER JOIN #BilledGroupItems BGI ON BGI.BILLDETAILID = BD.BILLDETAILID  
  INNER JOIN POS_BILL B ON B.BILLID = BD.BILLID                      
  INNER JOIN POS_ITEMPRICE IP ON IP.ITEMPRICEID = BD.ITEMPRICEID                      
  INNER JOIN POS_ITEMCODE IC ON IC.ITEMCODEID = IP.ITEMCODEID                      
  INNER JOIN POS_ITEM I ON I.ITEMID = IC.ITEMID                      
  INNER JOIN POS_GSTDETAIL GST ON GST.GSTID = IP.GSTID       
  LEFT JOIN POS_OFFER OFR ON OFR.OFFERID = BD.OFFERID  
  LEFT JOIN POS_OFFERTYPE OFRTYP ON OFRTYP.OFFERTYPEID = OFR.OFFERTYPEID  
END 
GO

UPDATE TBLCONFIG SET CONFIGVALUE = '1.7.6' WHERE CONFIGID = 1
GO
